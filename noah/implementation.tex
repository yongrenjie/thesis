\subsection{Implementation details}
\label{subsec:noah__genesis_implementation}

I will now describe a few features of GENESIS pulse programmes, as well as how these are implemented.
The GENESIS code is written in TypeScript; during deployment, this is compiled to JavaScript, which can then be directly executed in the client's web browser.
No server-side code is required, meaning that the GENESIS web page is actually a static site (it is currently hosted using GitHub Pages).

\begin{mylisting}[!htbp] % lst:genesis_sc {{{1
\begin{tcbminted}{text}
/* PREAMBLE */
; gns_noah2-SCqf
; 13C HSQC
; 1H magnitude-mode COSY
"d4          = 0.25s/cnst2"  ; 13C INEPT
"in0         = inf1/2"       ; 13C HSQC increment
"in11        = 2*dw"         ; COSY increment
; ...
define delay DC_HSQCa
"DC_HSQCa    = d4-p14/2"
"l0          = td1/2"        ; TD1/NBL

/* MAIN SECTION */
1 ze
4 d1 st0
  ; MODULE 1 - HSQC
  (p1 ph0):f1
  ; ...
  goscnp ph30 cpd2:f2
  50u do:f2
  2m st
  ; MODULE 2 - COSY
  (p1 ph12):f1
  ; ...
  go=2 ph26
  1m iu1        ; TD1/NBL counter
  1m igrad EA   ; echoâ€“antiecho gradients
  1m id11       ; COSY t1
  30m wr #0 if #0 zd
if "l1 % 2 == 0" {
  1m id0        ; HSQC t1
}
  lo to 4 times l0
exit

/* EPILOGUE */
ph0=0
;gpnam4: SMSQ10.100
;gpz4: 70% (13C CTP)
;cpd2:wvm:wudec: cawurst_d-20(220 ppm, 1.4 ms; L2H)
;d4: 1/4J(CH)
;auprog: noah_hsqc:noah_cosy QF
;module identifiers: C_HSQC H_COSY_QF
;pulse programme created by genesis-v2.2.2, https://nmr-genesis.co.uk
;Sun Sep 11 2022 16:04:54 GMT+0800 (Malaysia Time)
\end{tcbminted}
    \caption[Abridged GENESIS pulse programme]{Abridged GENESIS pulse programme for the \noah{S,C} supersequence shown in \cref{fig:noah_timings_noah_sc}.}
    \label{lst:genesis_sc}
\end{mylisting} % }}}1

\subsubsection{Overall structure}

The algorithm used for pulse programme construction can loosely be separated into three parts, which are shown in \cref{lst:genesis_sc}:
\begin{enumerate}
    \item the \textit{preamble}, which consists of everything up until the beginning of the actual pulse sequence (the \texttt{ze} command). This includes header comments as well as definitions of parameters, such as delays and pulse widths;
    \item the \textit{main section}, which contains the actual pulse sequence;
    \item the \textit{epilogue}, which contains phase cycle information as well as footer comments describing each parameter. Instructions for generating shaped pulses using Bruker's WaveMaker software are also included here, as well as instructions for automatic processing (\cref{subsec:noah__genesis_processing}), and comments indicating how the pulse programme was generated (for reproducibility purposes).
\end{enumerate}

The construction of the preamble and main section is largely accomplished through the collation of module-specific information, the most important of which are:
\begin{itemize}
    \item information about the module itself, which go into the header comments;
    \item parameter definitions, which are collated to form the preamble. Duplicates must be removed here to avoid errors; and
    \item the pulse programmes themselves, which are directly concatenated to form the main section.
\end{itemize}
These, as well as other smaller bits of information (e.g.\ relevant citations, appropriate processing scripts), are stored within \texttt{NOAHModule} objects.
Each distinct module corresponds to one such object.
Therefore, if one wants to add a new module to GENESIS, most of the work can be completed by simply defining a new \texttt{NOAHModule} object: no changes to the algorithm itself are needed.

To put the epilogue together, the pulse programme constructed so far is scanned for pulse phases, shaped pulses, and all other parameters.
Using predefined lookup tables, GENESIS then outputs pulse phase definitions, WaveMaker directives (where appropriate), and comments containing textual descriptions of each parameter.
These comments are mostly cosmetic, but are very useful to the user as they are displayed in the \texttt{ased} screen when setting up an experiment.
Finally, instructions for automatic processing of the NOAH data (explained in \cref{subsec:noah__genesis_motivation}) are added to the bottom, together with the version number and a timestamp (for reproducibility purposes).

\subsubsection{Phase/delay incrementation and looping}

Since NOAH experiments are 2D experiments, there is one additional complication: the pulse programme must contain appropriate looping statements, together with pulse phase and delay incrementation, in order to correctly generate the indirect dimension.
In many existing NOAH pulse programmes, looping in 2D experiments was written using the equivalent of \texttt{for} loops (\cref{lst:genesis_looping}, \textit{left}).
Although this suffices for the vast majority of supersequences, whenever anything must be incremented in a different way (e.g.\ for parallel supersequences, or the PSYCHE module which uses a different number of $t_1$ increments), the nested loop structure must be modified.
I therefore opted to change the structure to use only one loop, and to control the phase and delay incrementation using modular arithmetic (\cref{lst:genesis_looping}, \textit{right}).
The outcome is entirely equivalent, but edge cases can be implemented simply by adding another check on the loop counter \texttt{L1}.

\begin{mylisting}[!ht] % lst:genesis_looping {{{1
\begin{tcbmintedsbs}{text}
\begin{minted}[fontsize=\small]{text}
"l0 = td1/4"


1 ze
3 1m
4 d1 st0

  ; ... (pulse sequence goes here)

  ; in inner loop
  1m igrad EA   ; HSQC gradients
  1m id11       ; COSY t1
  30m wr #0 if #0 zd
  lo to 4 times 2

  ; in outer loop
  1m ip5*2      ; HSQC 13C 90
  1m ip30*2     ; HSQC receiver
  1m id0        ; HSQC t1
  lo to 3 times l0



end
\end{minted}
\tcblower
\begin{minted}[fontsize=\small]{text}
"l0 = td1/2"
"l1 = 0"

1 ze
4 d1 st0


  ; ... (pulse sequence goes here)

  ; on every pass
  1m iu1        ; loop counter
  1m igrad EA   ; HSQC gradients
  1m id11       ; COSY t1
  30m wr #0 if #0 zd

  ; on every second pass
  if "l1 % 2 == 0" {
    1m ip5*2      ; HSQC 13C 90
    1m ip30*2     ; HSQC receiver
    1m id0        ; HSQC t1
  }
  lo to 4 times l0

end
\end{minted}
\end{tcbmintedsbs}
    \caption[GENESIS implementation of looping]{Implementation of phase/delay incrementation and looping in previous NOAH sequences (\textit{left}, using nested loops) and in GENESIS (\textit{right}, using modular arithmetic).}
    \label{lst:genesis_looping}
\end{mylisting} % }}}1


\subsubsection{Parameter standardisation}

Each NOAH module contains a number of parameters, including pulse widths, delays, gradient amplitudes, shaped pulse waveforms.
Since different modules are stored separately (as different objects), directly concatenating their pulse programmes may lead to conflicting parameter definitions.
GENESIS avoids this by maintaining a global table of parameter definitions which are applied to all modules: when new modules are added, they must be checked against this to ensure that there are no inconsistencies.

In general, where possible, these parameters are chosen to be consistent with pulse programmes in the Bruker standard library: thus, for example, \texttt{P1} is the \proton{} \ang{90} pulse width, and \texttt{CNST2} is the $\oneJ{CH}$ value used for calculating INEPT delays.
This makes it easy to read in parameters either from the \textit{prosol} relation tables in TopSpin, or from other existing parameter sets.
Some delays are module-specific and do not need to be reused, and in standard library sequences, are often labelled as \texttt{DELTA1}, \texttt{DELTA2}, and so on.
To avoid conflicting definitions and also to improve readability, I rename these such that they include the name of the module: thus, in a \carbon{} HSQC these may be labelled \texttt{DC\_HSQC\_1}.
Here, \texttt{C\_HSQC} is the module code, which will be explained further below.

If combined with some caution when adding new modules, these measures ensure that \textit{within} a supersequence there are no parameter clashes: we may view this as a \textit{local uniqueness} of parameters.
However, the impact of this design choice is even more far-reaching:
since parameters are stored globally, they will always have the same value in \textit{all} possible supersequences (or in other words, the parameters are \textit{globally unique}).
This makes it exceptionally easy to set up multiple different supersequences in TopSpin: virtually all of the parameter values may simply be copied from a previous NOAH dataset.

One potential issue with this strategy is that TopSpin provides a finite number of named pulse widths (for example).
Thus, there are only so many different parameters which can be stored in a global table before running into inevitable conflicts.
A workaround would be to sacrifice the global uniqueness of each parameter, and only have it be unique within a given supersequence.
Fortunately, this situation has not (yet) surfaced.%
\footnote{The number of \textit{pulse phases} in particular, though, is dangerously close to the maximum number of 32. In fact, the global uniqueness criterion is not really important for pulse phases, because---unlike, say, delays---pulse phases are hardcoded in the pulse programme, and cannot be copied from one dataset to another. So, if necessary, I could dispense with the global uniqueness for pulse phases, at the cost of some increased code complexity. I did briefly contemplate this possibility, but since I am at the end of my DPhil and am unlikely to add any new modules soon, this will remain a hypothetical---for now.}


\subsubsection{Parameter descriptions}

\subsubsection{Module choice}

Developer mode

\subsubsection{Tests}
\subsubsection{How smart is GENESIS?}

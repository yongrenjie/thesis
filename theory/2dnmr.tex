\subsection{2D NMR: general principles}
\label{subsec:theory__2dnmr}

Much of this thesis is concerned with two-dimensional (2D) NMR experiments.
Before considering an explicit example of a 2D experiment, we will first describe some general principles.\autocite{Aue1976JCP_2D,Jeener2016PNMRS}
2D experiments contain one \textit{indirect} and one \textit{direct} time dimension, traditionally labelled $t_1$ and $t_2$ respectively.
The $t_1$ period is a variable period which starts at $0$\footnote{Or \textit{as close to 0 as possible}, considering that pulse elements during $t_1$---such as the $\ang{180}(I)$ pulse in \cref{fig:hsqc_ph}---require finite amounts of time. In some cases, it is possible to arrange spin echoes around $t_1$ such that the $t_1$ evolution on the first increment is refocused.} and is incremented by a constant amount $\delta(t_1)$ on every iteration of the sequence.
For each value of $t_1$ (or each $t_1$ \textit{increment}) one complex signal $s'(t_2)$ is obtained.
Putting this all together, the raw data is thus of the form $s(t_1, t_2)$, which can be viewed as a 2D data matrix.
Fourier transformation in both dimensions leads to a spectrum $S(\omega_1, \omega_2)$.
In experimental contexts, the frequency dimensions are often referred to as $F_1$ and $F_2$, but in this chapter I stick to the more mathematically consistent $\omega$.

2D experiments generally comprise four components: \textit{preparation}, \textit{evolution}, \textit{mixing}, and \textit{detection}.
The relevant product operators broadly follow this pattern:
\begin{equation}
    \label{eq:2d_pemd}
    \rho'_0 \,\,\xrightarrow[]{\textit{preparation}} \,\, P \,\, \xrightarrow[]{\textit{evolution}} \,\, P\cos(\Omega_P t_1) + P'\sin(\Omega_P t_1) \,\, \xrightarrow[]{\textit{mixing}} \,\, Q\cos(\Omega_P t_1) + \cdots
\end{equation}
Here, $P$ is some operator which, during the $t_1$ period, evolves into $P'$ at a frequency of $\Omega_P$ (as per \cref{fig:prodop_rules}).
This leads to two terms which are \textit{amplitude-modulated} in $t_1$.
The mixing process simply transforms the operator $P$ to $Q$; for now, we will assume that the sine-modulated term $P'$ is turned into unobservable magnetisation.

During the detection period, the $x$- and $y$-magnetisation generated by the term $Q$ is recorded.
As discussed in \cref{subsec:theory__pulseacq}, $Q$ must therefore be (or at least contain) $-1$-quantum coherence on some spin, and thus evolves at the offset of that spin, $\Omega_Q$.
The complex signal $s(t_1, t_2)$ is therefore of the form $\cos(\Omega_P t_1)\exp(\mi \Omega_Q t_2)$.
Note that, since the term $P$ is not directly detected, it can have \textit{any} coherence order.

We can equivalently express this signal as a sum of complex exponentials, which is easier to Fourier transform:
\begin{equation}
    \label{eq:2d_cos_exp_sum}
    s(t_1, t_2) = \cos(\Omega_P t_1)\exp(\mi \Omega_Q t_2) = \frac{1}{2}\bigl[\exp(\mi\Omega_P t_1)\exp(\mi\Omega_Q t_2) + \exp(-\mi\Omega_P t_1)\exp(\mi\Omega_Q t_2)\bigr]
\end{equation}
Fourier transformation of the first term reveals a peak centred at $(\omega_1, \omega_2) = (\Omega_P, \Omega_Q)$:
\begin{align}
    \label{eq:ft_2d_phasetwist}
    \mathcal{F}[\exp(\mi\Omega_P t_1)\exp(\mi\Omega_Q t_2)]
        &= [A_1(\Omega_P) + \mi D_1(\Omega_P)][A_2(\Omega_Q) + \mi D_2(\Omega_Q)] \notag \\
        &= A_1(\Omega_P)A_2(\Omega_Q) - D_1(\Omega_P)D_2(\Omega_Q) \notag \\
        &\quad\quad + \mi[A_1(\Omega_P)D_2(\Omega_Q) + D_1(\Omega_P)A_2(\Omega_Q)],
\end{align}
where we have used the shorthand $A_i(\Omega)$ to denote what should properly be written as $A(\omega_i;\Omega)$.
We should ideally like our 2D peaks to be absorption-mode in both dimensions, i.e.\ $S(\omega_1, \omega_2) = A_1(\Omega_P)A_2(\Omega_Q)$.
Unfortunately, if we take the real part of this spectrum, we have an undesirable mixture of double absorption and double dispersion: this peak shape is called a \textit{phase twist}.

This is not the only problem, however: if we perform the same Fourier transformation on the second term in \cref{eq:2d_cos_exp_sum}, we get \textit{another} phase twist peak but this time centred at $(\omega_1, \omega_2) = (-\Omega_P, \Omega_Q)$.
So, merely obtaining the complex signal $s(t) = \cos(\Omega_P t_1)\exp(\mi\Omega_Q t_1)$ is clearly not good enough.
Firstly, our spectra are not \textit{pure phase} or \textit{phase-sensitive}, in that the peaks are an inseparable mixture of absorptive and dispersive lineshapes.
Secondly, we have lost \textit{quadrature detection} in the indirect dimension, in that we cannot distinguish positive from negative offsets.

There are multiple different ways of solving these dual issues, which are extensively covered in NMR textbooks.\autocite{Ernst1987,Keeler2010,Levitt2008,Claridge2016,Cavanagh2007}
Among these are the States method\autocite{States1982JMR}, the \ac{tppi} method\autocite{Marion1983BBRC}, and the \ac{ea} method.
I will briefly cover the States and EA methods; the TPPI method can be shown to be essentially mathematically equivalent to the States method\autocite{Keeler1985JMR}.%
\footnote{There is a slight difference in that the TPPI method pushes \textit{axial peaks}---artefacts arising at $\omega_1 = 0$---to the edge of the spectrum, whereas with the States method, these artefacts appear in the middle of the spectrum, potentially obscuring useful peaks. The reader is referred to the references cited in the main text for a discussion of this.
In practice, both the States and EA methods can be easily adapted to incorporate this shifting of axial peaks by phase shifting the $t_1$ modulation as well as the receiver by \ang{180} every time $t_1$ is incremented (in the former case it is creatively known as the \textit{States--TPPI method}).
Thus, I do not consider the TPPI method any further here.}

In the States method, the cosine-modulated signal described above (and denoted $s_\text{cos}(t_1, t_2)$ here) forms only one part of the signal.
It is also necessary to acquire a \textit{sine-modulated signal} of the form $s_\text{sin}(t_1, t_2) = \sin(\Omega_P t_1)\exp(\Omega_Q t_2)$.
Once we have these two datasets, we can perform a Fourier transform along $\omega_2$ first to get two intermediate signals:
\begin{align}
    \label{eq:states_1}
    s'_\text{cos}(t_1, \omega_2) &= \cos(\Omega_P t_1) [A_2(\Omega_Q) + \mi D_2(\Omega_Q)] \\
    s'_\text{sin}(t_1, \omega_2) &= \sin(\Omega_P t_1) [A_2(\Omega_Q) + \mi D_2(\Omega_Q)].
\end{align}
(If desired, phase correction along the $\omega_2$ dimension \textit{must} be performed at this stage before moving on.)
We then discard the imaginary parts of these signals and use their real parts to construct another complex signal:
\begin{equation}
    \label{eq:states_3}
    s''(t_1, \omega_2) = \Re\{s'_\text{cos}(t_1, \omega_2)\} + \mi \Re\{s'_\text{sin}(t_1, \omega_2)\} = \exp(\mi \Omega_P t_1)A_2(\Omega_Q).
\end{equation}
Fourier transformation along $\omega_1$ yields
\begin{equation}
    \label{eq:states_4}
    S(\omega_1, \omega_2) = [A_1(\Omega_P) + \mi D_1(\Omega_P)] A_2(\Omega_Q),
\end{equation}
which represents a peak only at the correct frequency $(\Omega_P, \Omega_Q)$, and the real part of which is the desired double-absorption lineshape.
Phase correction along $\omega_1$ can now be carried out.%
\footnote{This treatment of the States method stems from the original paper\autocite{States1982JMR} and is consistently reproduced in textbooks, although I have personally always found the steps rather contrived.
    I argue instead that a more coherent formulation can be given in terms of \textit{quaternions}, a type of \textit{hypercomplex number}, expressed as $a + \mathrm{i}b + \mathrm{j}c + \mathrm{k}d$ where $a, b, c, d \in \mathbb{R}$, $\mathrm{i}^2 = \mathrm{j}^2 = \mathrm{k}^2 = -1$, and $\mathrm{ij = -ji = k}$.
    We can write that $s_\text{cos} = \cos(\Omega_P t_1)\exp(\mathrm{j}\Omega_Q t_2)$, and that $s_\text{sin} = \sin(\Omega_P t_1)\exp(\mathrm{j}\Omega_Q t_2)$; then, we can directly form a quaternionic 2D matrix $s(t_1, t_2) = s_\text{cos} + \mi s_\text{sin} = \exp(\mi\Omega_P t_1)\exp(\mathrm{j}\Omega_Q t_2)$.
    At this point, we can use a quaternion Fourier transform to \textit{directly} obtain the data: $S(\omega_1, \omega_2) = (2\pi)^{-1}\iint \exp(-\mi\omega_1 t_1)s(t_1, t_2) \exp(-\mathrm{j}\omega_2 t_2)$, and phase correction in \textit{both} dimensions can be carried out at will and simultaneously using
    $\exp(\mi \phi_\text{corr,1})S(\omega_1, \omega_2) \exp(\mathrm{j}\phi_\text{corr,2})$, where the $\phi_\text{corr}$'s represent the phase corrections in the two respective frequency dimensions.
    Indeed, in the representation of 2D data as used by Bruker instruments, the four files \texttt{2rr}, \texttt{2ri}, \texttt{2ir}, and \texttt{2ii} essentially correspond to the four components (or \textit{quadrants}) of a quaternionic $S(\omega_1, \omega_2)$.
    Of course, this is merely nice notation: none of the underlying science is changed.
    But the beauty of this is that we can consider the steps given in the main text to be an \textit{implementation} of something more fundamental (the quaternionic Fourier transform), a generalisation which naturally follows from the 1D case and immediately suggests its extension to the 3D case, rather than a \textit{prescription} which---at least to a novice---seems to work only as if by magic.
    This treatment has been proposed before by Delsuc\autocite{Delsuc1988JMR}, although it does not appear to have caught on much.
}

Naturally, the obvious question is how the sine-modulated signal $s_\text{sin}(t_1, t_2)$ can be obtained.
Returning to the product operators in \cref{eq:2d_pemd}, we see that we can obtain this if we change the mixing period to transform $P' \to Q$ instead of $P \to Q$.
This can usually be done by phase shifting one or more pulses after the $t_1$ period by \ang{90}.\footnote{Actually, if double-quantum coherence is sampled in $t_1$, then the phase shift used must be halved, i.e.\ \ang{45}; and likewise for higher coherence orders. But we will not encounter such cases in this thesis.}
Alternatively (in fact, more commonly), we can modify the preparation period such that it produces an operator $-P'$ which rotates into $P$ during $t_1$.
That way, after the $t_1$ evolution period we have a density operator of the form $-P'\cos(\omega_P t_1) + P\sin(\omega_P t_1)$; if we keep the mixing period the same then we will obtain the desired sine-modulated data.
In contrast to before, this can be done by phase shifting one or more pulses before the $t_1$ period by \ang{-90}.

On the other hand, the EA method seeks instead to measure two signals which are \textit{phase-modulated} in $t_1$ (instead of \textit{amplitude-modulated} as in the States method):
\begin{align}
    s_\text{echo}(t_1, t_2) &= \frac{1}{2}\exp(-\mi\Omega_P t_1)\exp(\mi\Omega_Q t_2) \label{eq:echo_antiecho_1a} \\
    s_\text{antiecho}(t_1, t_2) &= \frac{1}{2}\exp(\mi\Omega_P t_1)\exp(\mi\Omega_Q t_2) \label{eq:echo_antiecho_1b}
\end{align}
Once recorded, these signals can be added and subtracted to obtain the cosine- and sine-modulated signals of the States method; the standard States processing can then follow.
The echo and antiecho signals can be obtained through the use of pulsed field gradients during the $t_1$ period, though a concrete example is deferred until the next section.
The factor of $1/2$ in \cref{eq:echo_antiecho_1a,eq:echo_antiecho_1b} requires an explanation: this arises because the `original' signal is cosine- or sine-modulated, which can be thought of as a sum of two opposite phase modulations, i.e.\ $\cos(\Omega_P t_1) = [\exp(-\mi\Omega_P t_1) + \exp(\mi\Omega_P t_1)]/2$.
The gradients effectively select for only one sense of the phase modulation and reject the other.
Although this factor of $1/2$ can be cancelled out when combining the echo and antiecho datasets, in that:
\begin{equation}
    \label{eq:s_cos_from_antiecho}
    s_\text{cos,EA} = s_\text{echo} + s_\text{antiecho} = \cos(\Omega_P t_1)\exp(\mi\Omega_Q t_2) = s_\text{cos}
\end{equation}
(and likewise for the sine component), the process of adding up two separate datasets leads to a $\sqrt{2}$ increase in the noise level when compared to measuring $s_\text{cos}$ directly.
Therefore, EA spectra have a $\sqrt{2}$ decrease in signal-to-noise ratio (SNR) compared to their States counterparts.
This point is explored more fully in an article by Keeler and coworkers.\autocite{Kontaxis1994JMRSA}
Despite this loss in SNR, the use of gradients typically leads to spectra with far better artefact suppression, completely obviating the need for long phase cycles.
Consequently, a significant proportion of modern 2D experiments---especially heteronuclear experiments---use EA selection.
